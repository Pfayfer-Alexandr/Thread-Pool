# Кастомный пул потоков

## Обзор

Этот проект реализует кастомный пул потоков на Java, предоставляя гибкое и масштабируемое решение для управления параллельными задачами. Кастомный пул потоков разработан для обеспечения лучшего контроля над распределением задач и балансировкой нагрузки по сравнению со стандартными пулами потоков.

## Особенности

- **Несколько очередей задач**: Распределяет задачи по нескольким очередям для лучшей балансировки нагрузки.
- **Динамические рабочие потоки**: Динамически добавляет и удаляет рабочие потоки в зависимости от текущей нагрузки.
- **Настраиваемые параметры**: Позволяет тонко настраивать размер основного пула, максимальный размер пула, время жизни потока и размер очереди.
- **Обработка отказов**: Реализует кастомный обработчик отказов для управления перегрузками задач.

## Анализ производительности

### Сравнение со стандартными пулами потоков

1. **ThreadPoolExecutor (Стандартная библиотека Java)**
   - **Преимущества**: Оптимизирован, хорошо протестирован, поддерживает широкий диапазон параметров настройки.
   - **Недостатки**: Менее гибкий в настройке, нет встроенной поддержки нескольких очередей.

2. **ForkJoinPool (Стандартная библиотека Java)**
   - **Преимущества**: Оптимизирован для задач типа "разделяй и властвуй", эффективен для рекурсивных задач.
   - **Недостатки**: Менее подходит для общих задач, сложнее в настройке.

3. **Пулы потоков Tomcat/Jetty**
   - **Преимущества**: Оптимизированы для веб-серверов, поддерживают динамическое изменение размера пула.
   - **Недостатки**: Специализированы для веб-задач, могут быть избыточны для общих задач.

### Сравнение с кастомным пулом потоков

- **Гибкость**: Кастомный пул потоков позволяет более гибко настраивать параметры, такие как количество очередей, стратегии балансировки и обработки отказов.
- **Производительность**: В тестах кастомный пул показал сравнимую производительность с ThreadPoolExecutor при оптимальных настройках, но уступает в некоторых сценариях из-за накладных расходов на балансировку.
- **Масштабируемость**: Кастомный пул потоков лучше масштабируется в сценариях с неравномерной нагрузкой благодаря динамическому добавлению рабочих потоков.

## Оптимизация параметров

### Оптимальные параметры

1. **corePoolSize**: Оптимальное значение зависит от количества ядер процессора. Для 4-ядерного процессора оптимальное значение — 4.
2. **maxPoolSize**: Должно быть больше corePoolSize, но не слишком большим, чтобы избежать избыточного потребления ресурсов. Оптимальное значение — 8.
3. **keepAliveTime**: Оптимальное значение — 5 секунд. Это позволяет быстро освобождать неиспользуемые потоки, но не слишком часто создавать новые.
4. **queueSize**: Оптимальное значение — 10. Это позволяет балансировать нагрузку между очередями, но не слишком большой, чтобы избежать задержек.

### Влияние параметров на производительность

- **corePoolSize**: Увеличение corePoolSize улучшает производительность до определенного предела (количество ядер процессора), после чего производительность не изменяется.
- **maxPoolSize**: Увеличение maxPoolSize улучшает производительность при пиковых нагрузках, но может привести к избыточному потреблению ресурсов.
- **keepAliveTime**: Уменьшение keepAliveTime позволяет быстрее освобождать неиспользуемые потоки, но может привести к частым созданиям новых потоков.
- **queueSize**: Увеличение queueSize позволяет лучше балансировать нагрузку, но может привести к задержкам в обработке задач.

## Механизм распределения задач

### Распределение задач между очередями

В кастомном пуле потоков используется несколько очередей для распределения задач. Каждая очередь связана с определенным рабочим потоком. Задачи распределяются между очередями по принципу round-robin, что позволяет равномерно распределять нагрузку между рабочими потоками.

### Балансировка нагрузки

При добавлении задачи в очередь проверяется, есть ли свободные рабочие потоки. Если все рабочие потоки заняты, создается новый рабочий поток (если не достигнуто максимальное количество потоков). Это позволяет динамически адаптироваться к изменяющейся нагрузке.

### Обработка отказов

При перегрузке пула задач используется обработчик отказов, который может либо откладывать выполнение задач, либо отказывать в их выполнении. Это позволяет избежать перегрузки системы и обеспечить стабильную работу пула.

## Заключение

Кастомный пул потоков предоставляет гибкость и масштабируемость, что делает его подходящим для различных сценариев использования. Оптимальные параметры зависят от конкретных условий и нагрузки, но в целом кастомный пул показывает хорошие результаты в сравнении со стандартными решениями.
